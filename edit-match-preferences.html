<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Match Preferences</title>
    <link rel="stylesheet" href="edit-match-preferences.css">
</head>
<body>
    <h1>Create Your Match Preferences</h1>  
    <div id="preferences-container">
        <!-- Sports preferences will be dynamically inserted here -->
    </div>
    <button id="submit-button" disabled>Submit</button>

    <script>
        // Retrieve data from localStorage
        const profileData = JSON.parse(localStorage.getItem('profileData'));
        const savedPreferences = JSON.parse(localStorage.getItem('matchPreferences')) || [];
    
        if (profileData && profileData.sports) {
            const container = document.getElementById('preferences-container');
    
            // Loop through each sport and create sections
            profileData.sports.forEach(({ sport }) => {
                const section = document.createElement('div');
                section.className = 'sport-section';
    
                // Add sport title
                const sportTitle = document.createElement('h2');
                sportTitle.textContent = sport;
                section.appendChild(sportTitle);
    
                // Retrieve saved preferences for this sport
                const savedPreference = savedPreferences.find(pref => pref.sport === sport) || {};

                // Add age range question and dual range slider
                const ageRangeQuestion = document.createElement('div');
                ageRangeQuestion.className = 'question';
                ageRangeQuestion.textContent = 'What is your preferred age range for matching?';
                section.appendChild(ageRangeQuestion);

                const ageRangeSliderContainer = document.createElement('div');
                ageRangeSliderContainer.className = 'slider-container';

                // Dual range slider for minimum and maximum age
                const minAgeSlider = document.createElement('input');
                minAgeSlider.type = 'range';
                minAgeSlider.min = 1;
                minAgeSlider.max = 120;
                minAgeSlider.value = savedPreference.minAge || 18;  // Default value
                minAgeSlider.id = `${sport}-min-age-slider`;
                minAgeSlider.classList.add('age-range-slider');
                ageRangeSliderContainer.appendChild(minAgeSlider);

                const maxAgeSlider = document.createElement('input');
                maxAgeSlider.type = 'range';
                maxAgeSlider.min = 1;
                maxAgeSlider.max = 120;
                maxAgeSlider.value = savedPreference.maxAge || 30;  // Default value
                maxAgeSlider.id = `${sport}-max-age-slider`;
                maxAgeSlider.classList.add('age-range-slider');
                ageRangeSliderContainer.appendChild(maxAgeSlider);

                const ageRangeValueDisplay = document.createElement('span');
                ageRangeValueDisplay.textContent = `Age Range: ${minAgeSlider.value} - ${maxAgeSlider.value}`;
                ageRangeSliderContainer.appendChild(ageRangeValueDisplay);

                // Update the displayed value as the sliders are moved
                minAgeSlider.addEventListener('input', function () {
                    if (parseInt(minAgeSlider.value) > parseInt(maxAgeSlider.value)) {
                        maxAgeSlider.value = minAgeSlider.value;
                    }
                    ageRangeValueDisplay.textContent = `Age Range: ${minAgeSlider.value} - ${maxAgeSlider.value}`;
                    checkFormValidity();
                });

                maxAgeSlider.addEventListener('input', function () {
                    if (parseInt(maxAgeSlider.value) < parseInt(minAgeSlider.value)) {
                        minAgeSlider.value = maxAgeSlider.value;
                    }
                    ageRangeValueDisplay.textContent = `Age Range: ${minAgeSlider.value} - ${maxAgeSlider.value}`;
                    checkFormValidity();
                });

                section.appendChild(ageRangeSliderContainer);

                // Add gender preference question and options
                const genderPreferenceQuestion = document.createElement('div');
                genderPreferenceQuestion.className = 'question';
                genderPreferenceQuestion.textContent = 'Would you prefer to match with people of the same gender?';
                section.appendChild(genderPreferenceQuestion);
    
                const genderPreferenceOptions = document.createElement('div');
                genderPreferenceOptions.className = 'options';
    
                const genderOptions = ['Same Gender', 'Any Gender'];
                genderOptions.forEach(option => {
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `${sport}-gender-preference`;
                    input.value = option;
                    if (savedPreference.genderPreference === option) input.checked = true;
                    input.addEventListener('change', checkFormValidity);
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(option));
                    genderPreferenceOptions.appendChild(label);
                });
    
                section.appendChild(genderPreferenceOptions);
    
                // Add skill level question and options
                const skillLevelQuestion = document.createElement('div');
                skillLevelQuestion.className = 'question';
                skillLevelQuestion.textContent = 'Would you prefer to match with people of the same skill level?';
                section.appendChild(skillLevelQuestion);
    
                const skillLevelOptions = document.createElement('div');
                skillLevelOptions.className = 'options';
    
                const skillOptions = ['Same Skill Level', 'Any Skill Level'];
                skillOptions.forEach(option => {
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `${sport}-skill-level`;
                    input.value = option;
                    if (savedPreference.skillLevel === option) input.checked = true;
                    input.addEventListener('change', checkFormValidity);
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(option));
                    skillLevelOptions.appendChild(label);
                });
    
                section.appendChild(skillLevelOptions);
    
                // Add location preferences question and options
                const locationQuestion = document.createElement('div');
                locationQuestion.className = 'question';
                locationQuestion.textContent = 'Choose preferred locations to find matches: (can choose multiple options)';
                section.appendChild(locationQuestion);
    
                const locationOptions = document.createElement('div');
                locationOptions.className = 'options';
    
                const locations = ['North', 'South', 'East', 'West', 'Central'];
                locations.forEach(location => {
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = `${sport}-location`;
                    input.value = location;
                    if (savedPreference.locations && savedPreference.locations.includes(location)) input.checked = true;
                    input.addEventListener('change', checkFormValidity);
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(location));
                    locationOptions.appendChild(label);
                });
    
                section.appendChild(locationOptions);
                container.appendChild(section);
            });
    
            // Check form validity based on all questions and sliders
            function checkFormValidity() {
                let valid = true;
    
                profileData.sports.forEach(({ sport }) => {
                    const minAgeSlider = document.querySelector(`#${sport}-min-age-slider`);
                    const maxAgeSlider = document.querySelector(`#${sport}-max-age-slider`);
                    const genderPreferenceSelected = document.querySelector(`input[name="${sport}-gender-preference"]:checked`);
                    const skillLevelSelected = document.querySelector(`input[name="${sport}-skill-level"]:checked`);
                    const locationsSelected = Array.from(document.querySelectorAll(`input[name="${sport}-location"]:checked`)).length;
    
                    // Check if all options are selected
                    if (!minAgeSlider.value || !maxAgeSlider.value || !genderPreferenceSelected || !skillLevelSelected || locationsSelected === 0) {
                        valid = false;
                    }
                });
    
                // Enable/Disable submit button
                document.getElementById('submit-button').disabled = !valid;
            }
            
            // Handle form submission
            document.getElementById('submit-button').addEventListener('click', () => {
                let valid = true;

                profileData.sports.forEach(({ sport }) => {
                    const minAgeSlider = document.querySelector(`#${sport}-min-age-slider`);
                    const maxAgeSlider = document.querySelector(`#${sport}-max-age-slider`);
                    const genderPreferenceSelected = document.querySelector(`input[name="${sport}-gender-preference"]:checked`);
                    const skillLevelSelected = document.querySelector(`input[name="${sport}-skill-level"]:checked`);
                    const locationsSelected = Array.from(document.querySelectorAll(`input[name="${sport}-location"]:checked`)).length > 0;

                    if (!minAgeSlider.value || !maxAgeSlider.value || !genderPreferenceSelected || !skillLevelSelected || locationsSelected === 0) {
                        valid = false;
                    }
                });

                if (!valid) {
                    alert('Please select at least one option for each question before submitting.');
                } else {
                    const preferences = profileData.sports.map(({ sport }) => {
                        return {
                            sport,
                            minAge: document.querySelector(`#${sport}-min-age-slider`).value || '',
                            maxAge: document.querySelector(`#${sport}-max-age-slider`).value || '',
                            genderPreference: document.querySelector(`input[name="${sport}-gender-preference"]:checked`)?.value || '',
                            skillLevel: document.querySelector(`input[name="${sport}-skill-level"]:checked`)?.value || '',
                            locations: Array.from(document.querySelectorAll(`input[name="${sport}-location"]:checked`)).map(el => el.value),
                        };
                    });

                    localStorage.setItem('matchPreferences', JSON.stringify(preferences));
                }

                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.close();
                } else {
                    alert("This functionality is only available when the web app is opened through Telegram.");
                }
            });

        } else {
            // If no sports found, show a message
            const message = document.createElement('p');
            message.textContent = 'No sports preferences found. Please set up your profile.';
            document.body.appendChild(message);
        }


    </script>
</body>
</html>
